#region CheckIn User

        [TestMethod]
        public async Task Should_TranslateViewModel_when_GivenAValidViewModel()
        {
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);

            var vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User { BemsId = 123 }
            };

            var response = await _controller.CheckInUser(vm);
            _mockCheckInTranslator.Verify(t => t.GetCheckInRecordFromViewModel(vm, It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>()));
        }

        [TestMethod]
        public async Task Should_TranslateViewModel_AND_SetStatusToCheckIn()
        {
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);

            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User { BemsId = 123 }
            };

            var response = await _controller.CheckInUser(vm);

            _mockCheckInTranslator.Verify(t => t.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), "Check In", It.IsAny<bool>()));
        }

        [TestMethod]
        public async Task Should_TranslateViewModel_AND_SetSystemAction()
        {
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);

            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User { BemsId = 123 }
            };

            var response = await _controller.CheckInUser(vm);

            _mockCheckInTranslator.Verify(t => t.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), false));
        }

        // MODIFIED: Updated training data to use new training codes with valid 77517 for direct check-in
        [TestMethod]
        public async Task Should_SendsTranslatedCheckInRecordToCheckInService_when_TranslatationIsValid()
        {
            var returnedRecord = new CheckInRecord() { BemsId = 2519949, BadgeNumber = null };
            TrainingInfo trainingInfo = new()
            {
                BemsId = 2519949,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "Training 1"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "85914",
                        IsTrainingValid = true,
                        Name = "Training 2"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517AE",
                        IsTrainingValid = true,
                        Name = "Training 3"
                    }
                }
            };
            _mockCheckInTranslator.Setup(t => t.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(returnedRecord);
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);
            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);

            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User { BemsId = 123 },
            };

            var response = await _controller.CheckInUser(vm);

            _mockCheckInService.Verify(s => s.PostCheckinAsync(returnedRecord));
        }

        [TestMethod]
        public async Task Should_SetWorkAreasFromServicesToView_when_CheckIn()
        {
            var workAreas = new List<WorkArea>();
            _mockAirplaneService.Setup(s => s.GetActiveWorkAreasAsync(It.IsAny<string>(), It.IsAny<string>())).Returns(Task.FromResult<IList<WorkArea>>(workAreas));
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);

            var vm = new CheckInPartialViewModel();

            var response = await _controller.CheckInUser(vm);

            _mockAirplaneService.Verify(s => s.GetActiveWorkAreasAsync(It.IsAny<string>(), It.IsAny<string>()), Times.Once);

            Assert.AreEqual(workAreas, vm.WorkAreas);
        }

        // MODIFIED: Updated training data to use new training codes with valid 77517 for direct check-in
        [TestMethod]
        public async Task Should_DisplayErrorMessageInToast_when_CheckInServiceReturnsNullResponse()
        {
            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                bemsId = 2519949,
                CurrentUser = new User { BemsId = 123 },
            };

            TrainingInfo trainingInfo = new()
            {
                BemsId = 2519949,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "Training 1"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517AE",
                        IsTrainingValid = true,
                        Name = "Training 2"
                    }
                }
            };

            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Shield.Ui.App.Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult<HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>>(null));
            _mockSessionService.Setup(m => m.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);
            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 2519949, BadgeNumber = null });

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;

            Assert.IsTrue(viewResult.ViewData["Status"].Equals("Failed"));
            Assert.IsTrue(viewResult.ViewData["Message"].Equals("Unable to reach Check In Service, please try again."));
        }

        [TestMethod]
        public async Task Should_SendTranslatedViewModel_when_SuccessToCheckIn()
        {
            var successResponse = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.SUCCESS,
                Message = "WE DID IT!"
            };

            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User { BemsId = 234 }
            };

            _mockCheckInTranslator.Setup(t => t.GetNewCheckInPartialVMAfterSuccess(It.IsAny<CheckInPartialViewModel>())).Returns(vm);
            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Shield.Ui.App.Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult<HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>>(successResponse));
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);

            var result = await _controller.CheckInUser(vm) as PartialViewResult;
            var model = (CheckInPartialViewModel)result.Model;

            Assert.AreEqual(vm, model);

        }

        // MODIFIED: Updated training data to use new training codes with valid 77517 for direct check-in
        [TestMethod]
        public async Task Should_DisplayErrorToast_when_FailedToCheckIn()
        {
            var failedRes = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.FAILED,
                Message = "Check in Failed"
            };
            TrainingInfo trainingInfo = new()
            {
                BemsId = 123456,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "Training 1"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517PAE",
                        IsTrainingValid = true,
                        Name = "Training 2"
                    }
                }
            };

            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult<HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>>(failedRes));
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);
            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 2519949, BadgeNumber = null });

            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User { BemsId = 123 },
                bemsId = 123456
            };

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;
            CheckInPartialViewModel model = viewResult.Model as CheckInPartialViewModel;

            Assert.AreEqual(model.CurrentUser.BemsId, vm.CurrentUser.BemsId);
            _mockToastService.Verify(x => x.AddErrorToastMessage(failedRes.Message, It.IsAny<LibraryOptions>()));
        }

        // MODIFIED: Updated to test all trainings invalid - Override button scenario
        [TestMethod]
        public async Task Should_ReturntheTrainingStatusPartialView_When_All_Trainings_Are_Invalid()
        {
            TrainingInfo trainingInfo = new()
            {
                BemsId = 123456,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = false,
                        Name = "TR06005 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "85914",
                        IsTrainingValid = false,
                        Name = "85914 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517AE",
                        IsTrainingValid = false,
                        Name = "77517AE Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517PAE",
                        IsTrainingValid = false,
                        Name = "77517PAE Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517GC",
                        IsTrainingValid = false,
                        Name = "77517GC Training"
                    }
                }
            };
            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                overrideTraining = false,
                CurrentUser = new User { BemsId = 2830715 },
                bemsId = 123456
            };

            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 123456, BadgeNumber = null });
            _mockUserService.Setup(s => s.GetUserByBemsidAsync(It.IsAny<int>())).ReturnsAsync(new User { DisplayName = "Test_User" });

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;
            var model = (CheckInPartialViewModel)viewResult.Model;

            Assert.AreEqual("Partials/TrainingStatusPartial", viewResult.ViewName);
            Assert.AreEqual(trainingInfo.MyLearningDataResponse.Count, model.UserTrainingData.Count);
            Assert.AreEqual("Test_User", model.recordDisplayName);
            Assert.IsTrue(model.overrideTraining);
        }

        // MODIFIED: Updated to test proceed button scenario - some trainings valid but no 77517
        [TestMethod]
        public async Task Should_ReturntheTrainingStatusPartialView_When_No_77517_Trainings_Valid()
        {
            TrainingInfo trainingInfo = new()
            {
                BemsId = 123456,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "TR06005 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "85914",
                        IsTrainingValid = true,
                        Name = "85914 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517AE",
                        IsTrainingValid = false,
                        Name = "77517AE Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517PAE",
                        IsTrainingValid = false,
                        Name = "77517PAE Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517GC",
                        IsTrainingValid = false,
                        Name = "77517GC Training"
                    }
                }
            };
            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                overrideTraining = false,
                CurrentUser = new User { BemsId = 2830715 },
                bemsId = 123456
            };

            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 123456, BadgeNumber = null });
            _mockUserService.Setup(s => s.GetUserByBemsidAsync(It.IsAny<int>())).ReturnsAsync(new User { DisplayName = "Test_User" });

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;
            var model = (CheckInPartialViewModel)viewResult.Model;

            Assert.AreEqual("Partials/TrainingStatusPartial", viewResult.ViewName);
            Assert.AreEqual(trainingInfo.MyLearningDataResponse.Count, model.UserTrainingData.Count);
            Assert.AreEqual("Test_User", model.recordDisplayName);
            Assert.IsTrue(model.trainingConfirmation);
        }

        [TestMethod]
        public async Task Should_PersistWorkAreaData_When_ReturningThe_TrainingStatusPartialView()
        {
            TrainingInfo trainingInfo = new()
            {
                BemsId = 123456,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "TR06005 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517AE",
                        IsTrainingValid = false,
                        Name = "77517AE Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517PAE",
                        IsTrainingValid = false,
                        Name = "77517PAE Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517GC",
                        IsTrainingValid = false,
                        Name = "77517GC Training"
                    }
                }
            };
            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                overrideTraining = false,
                CurrentUser = new User { BemsId = 2830715 },
                bemsId = 123456,
                WorkAreaIdString = "10, 11"
            };

            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 123456, BadgeNumber = null });
            _mockUserService.Setup(s => s.GetUserByBemsidAsync(It.IsAny<int>())).ReturnsAsync(new User { DisplayName = "Test_User" });

            ActionResult result = await _controller.CheckInUser(vm);
            PartialViewResult viewResult = (PartialViewResult)result;
            CheckInPartialViewModel model = (CheckInPartialViewModel)viewResult.Model;

            Assert.AreEqual("Partials/TrainingStatusPartial", viewResult.ViewName);
            Assert.IsTrue(model.trainingConfirmation);
            Assert.IsNotNull(model.WorkAreaIdString);
            Assert.AreEqual(2, model.workArea.Count);
        }

        [TestMethod]
        public async Task Should_ReturntheCheckInPartialView_When_No_BemsId_For_BadgeData()
        {
            TrainingInfo trainingInfo = new()
            {
                BemsId = 0,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "TR06005 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517AE",
                        IsTrainingValid = false,
                        Name = "77517AE Training"
                    }
                }
            };
            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                overrideTraining = false,
                CurrentUser = new User { BemsId = 2830715 },
                nameOrBems = "123456789"
            };

            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 0, BadgeNumber = "123456789" });

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;

            Assert.AreEqual("Partials/CheckInPartial", viewResult.ViewName);
        }

        // MODIFIED: Updated to test visitor using name scenario - direct check-in without training validation
        [TestMethod]
        public async Task Should_DirectlyCheckIn_For_Visitor_Who_Entered_Name()
        {
            var successResponse = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.SUCCESS,
                Message = "Check In Successful"
            };

            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                overrideTraining = false,
                CurrentUser = new User { BemsId = 2830715 },
                nameOrBems = "Test_User",
                personType = "Visitor"
            };

            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 0, BadgeNumber = null, Name = "Test_User" });
            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult(successResponse));
            _mockCheckInTranslator.Setup(t => t.GetNewCheckInPartialVMAfterSuccess(It.IsAny<CheckInPartialViewModel>())).Returns(vm);

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;

            Assert.AreEqual("Partials/CheckInPartial", viewResult.ViewName);
            Assert.AreEqual("Success", viewResult.ViewData["Status"]);
            _mockCheckInService.Verify(s => s.PostCheckinAsync(It.IsAny<CheckInRecord>()), Times.Once);
        }

        // MODIFIED: Updated training data to use new training codes with valid 77517 for direct check-in
        [TestMethod]
        public async Task Should_ReturnErrorPartial_when_FailedToCheckIn()
        {
            var failedRes = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.FAILED,
                Message = "Check in Failed"
            };

            HTTPResponseWrapper<int> bemsWrapper = new HTTPResponseWrapper<int>
            {
                Data = 123
            };
            TrainingInfo trainingInfo = new()
            {
                BemsId = 2519949,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "TR06005 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517GC",
                        IsTrainingValid = true,
                        Name = "77517GC Training"
                    }
                }
            };

            _mockExternalService.Setup(s => s.GetBemsIdFromBemsIdOrBadgeNumber(It.IsAny<string>())).ReturnsAsync(bemsWrapper);
            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Shield.Ui.App.Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult<HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>>(failedRes));
            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 2519949, BadgeNumber = null });

            CheckInPartialViewModel vm = new CheckInPartialViewModel();
            vm.overrideTraining = false;
            vm.CurrentUser = new User { BemsId = 2830715 };
            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;

            Assert.AreEqual("Partials/CheckInPartial", viewResult.ViewName);
            _mockToastService.Verify(x => x.AddErrorToastMessage(failedRes.Message, It.IsAny<LibraryOptions>()));
        }

        // MODIFIED: Updated training data to use new training codes with valid 77517 for direct check-in
        [TestMethod]
        public async Task Should_ReturnCheckOutCheckInPartial_when_UserAlreadyCheckedIntoAnotherLine()
        {
            var errorMessage = "User 2519949 is currently checked in on Line 100. They must check out there in order to check in here.";
            var alreadyCheckedInResult = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.NOT_MODIFIED,
                Reason = Shield.Common.Constants.ShieldHttpWrapper.Reason.ALREADY_EXISTS,
                Message = errorMessage,
                Data = new Shield.Ui.App.Models.CommonModels.CheckInRecord
                {
                    BemsId = 2519949
                }
            };

            TrainingInfo trainingInfo = new()
            {
                BemsId = 2519949,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "TR06005 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517AE",
                        IsTrainingValid = true,
                        Name = "77517AE Training"
                    }
                }
            };

            HTTPResponseWrapper<int> bemsWrapper = new HTTPResponseWrapper<int>
            {
                Data = 2519949
            };

            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Shield.Ui.App.Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult(alreadyCheckedInResult));
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);
            _mockExternalService.Setup(s => s.GetBemsIdFromBemsIdOrBadgeNumber(It.IsAny<string>())).ReturnsAsync(bemsWrapper);
            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 2519949, BadgeNumber = null, WorkAreaIdString = "10, 11" });

            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                overrideTraining = false,
                CurrentUser = new User { BemsId = 123 },
                WorkAreaIdString = "10, 11"
            };

            ActionResult result = await _controller.CheckInUser(vm);
            PartialViewResult viewResult = (PartialViewResult)result;
            CheckInPartialViewModel model = (CheckInPartialViewModel)viewResult.Model;

            Assert.AreEqual("Partials/CheckOutCheckInPartial", viewResult.ViewName);
            Assert.AreEqual(model, vm);
            Assert.IsNotNull(model.WorkAreaIdString);
            Assert.AreEqual(2, model.workArea.Count);
        }

        [TestMethod]
        public async Task Should_ReturnErrorPartial_when_CheckOutUserByBemsFails()
        {
            var errorResult = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.FAILED,
                Message = "Failed to check out user",
                Data = null
            };

            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                bemsId = 123,
                checkOutNeededFlag = true,
                CurrentUser = new User { BemsId = 2830715 }
            };

            _mockCheckInService.Setup(x => x.PostCheckOutUserByBems(It.IsAny<int>())).Returns(Task.FromResult(errorResult));

            var result = await _controller.CheckInUser(vm) as PartialViewResult;

            Assert.AreEqual("../Shared/Error/ErrorPartial", result.ViewName);
            Assert.AreEqual("Failed to check out user", result.Model);
        }

        // MODIFIED: Updated training data with new codes
        [TestMethod]
        public async Task Should_CheckOutUser_when_CheckInUserCalled_and_CheckOutFlagIsTrue()
        {
            var checkOutResponse = new HTTPResponseWrapper<Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.SUCCESS,
                Message = string.Empty,
                Data = new Models.CommonModels.CheckInRecord()
            };

            var checkinPartialVM = new CheckInPartialViewModel
            {
                bemsId = 2519949,
                checkOutNeededFlag = true,
                CurrentUser = new User { BemsId = 2830715 }
            };

            TrainingInfo trainingInfo = new()
            {
                BemsId = 2519949,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "TR06005 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517AE",
                        IsTrainingValid = true,
                        Name = "77517AE Training"
                    }
                }
            };

            _mockCheckInService.Setup(s => s.PostCheckOutUserByBems(checkinPartialVM.bemsId)).Returns(Task.FromResult(checkOutResponse));
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);
            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 2519949, BadgeNumber = null });

            PartialViewResult viewResult = await _controller.CheckInUser(checkinPartialVM) as PartialViewResult;

            _mockCheckInService.Verify(s => s.PostCheckOutUserByBems(checkinPartialVM.bemsId));
            _mockCheckInService.Verify(s => s.PostCheckinAsync(It.IsAny<Models.CommonModels.CheckInRecord>()));
            _mockExternalService.Verify(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>()), Times.Once());
        }

        [TestMethod]
        public async Task Should_ReturnCheckInPartial_when_CheckInPartialModelIsNotValid()
        {
            // This is how you make the model invalid
            _controller.ModelState.AddModelError("fakeError", "NO DONT DO THIS!");

            CheckInPartialViewModel vm = new CheckInPartialViewModel();
            var result = await _controller.CheckInUser(vm);
            PartialViewResult viewResult = result as PartialViewResult;

            Assert.AreEqual("Partials/CheckInPartial", viewResult.ViewName);
        }

        [TestMethod]
        public async Task Should_ReturnAValidView_when_RouteToCheckInPageIsSuccessful()
        {
            var apRes = new Shield.Ui.App.Models.CommonModels.Aircraft
            {
                AssignedBargeCoordinatorBems = 88888,
                Site = "BSC",
                Model = "787",
                LineNumber = "500"
            };
            var bcRes = new User
            {
                BemsId = 2519949
            };

            _mockAirplaneService.Setup(aps => aps.GetAirplaneByModelLineNumberAsync(It.IsAny<string>(), It.IsAny<string>())).Returns(Task.FromResult(apRes));
            _mockUserService.Setup(us => us.GetUserByBemsidAsync(It.IsAny<int>())).Returns(Task.FromResult(bcRes));
            _mockSessionService.Setup(s => s.GetInt(It.IsAny<HttpContext>(), It.IsAny<string>())).Returns(123456);

            ViewResult res = await _controller.CheckIn("787", "500") as ViewResult;
            AircraftHeaderViewModel model = (AircraftHeaderViewModel)res.Model;

            // TODO
            Assert.AreEqual(model.Aircraft, apRes);
            Assert.AreEqual(model.BargeCoordinator, bcRes);
        }

        [TestMethod]
        public async Task Should_ReturnARedirectToSelectLine_when_RouteToCheckInPageFails()
        {
            _mockAirplaneService.Setup(aps => aps.GetAirplaneByModelLineNumberAsync(It.IsAny<string>(), It.IsAny<string>())).Returns(Task.FromResult<Shield.Ui.App.Models.CommonModels.Aircraft>(null));


            RedirectToActionResult res = await _controller.CheckIn("787", "500") as RedirectToActionResult;

            Assert.AreEqual("SelectLine", res.ActionName);
            Assert.AreEqual("Admin", res.ControllerName);
        }

        [TestMethod]
        public async Task Should_NotCheckIn_And_ReturnMessage_When_ThisLinesBCIsNotLoggedIn_And_CheckInDoesNotProvideBadgeOfTheBC()
        {
            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User(),
                assignedBCBems = _bcUser.BemsId
            };

            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(new User());
            _mockUserService.Setup(s => s.IsValidPin(It.IsAny<int>(), It.IsAny<string>())).ReturnsAsync(new HTTPResponseWrapper<bool>());
            var result = await _controller.CheckInUser(vm) as PartialViewResult;

            Assert.AreEqual("Partials/CheckInPartial", result.ViewName);
            _mockToastService.Verify(x => x.AddErrorToastMessage("Person Not Checked In. Scan The Correct Badge or Enter the correct PIN of This Line's CC.", It.IsAny<LibraryOptions>()));
        }

        // MODIFIED: Updated training data with new codes
        [TestMethod]
        public async Task Should_NotCheckIn_And_ReturnMessage_When_BC_PIN_Doesnot_Match()
        {
            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User(),
                assignedBCBems = _bcUser.BemsId,
                ConfirmingCCPin = "5679",
                assignedCCPin = "BCe0hOVnvgQJ2lRmUD092kCqmtYz+U0G+B7rfNVcz/M="
            };
            TrainingInfo trainingInfo = new()
            {
                BemsId = 2519949,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "TR06005 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517AE",
                        IsTrainingValid = true,
                        Name = "77517AE Training"
                    }
                }
            };

            IList<WorkArea> workAreaList = new List<WorkArea> { new WorkArea { Area = "some-work-area" } };
            _mockAirplaneService.Setup(s => s.GetActiveWorkAreasAsync(vm.site, vm.program)).ReturnsAsync(workAreaList).Verifiable();
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(new User()).Verifiable();
            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 2519949, BadgeNumber = null });

            // Act
            var result = await this._controller.CheckInUser(vm) as PartialViewResult;

            Assert.AreEqual("Partials/CheckInPartial", result.ViewName);
            _mockCheckInService.Verify(s => s.PostCheckinAsync(It.IsAny<CheckInRecord>()), Times.Never);
        }

        // MODIFIED: Updated training data with new codes
        [TestMethod]
        public async Task Should_NotCheckIn_And_ReturnMessage_When_BC_Badge_not_Found_In_External_Service()
        {
            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                personType = "Home Team",
                site = "some-site",
                program = "some-program",
                ConfirmingBCBadge = "3322323",
                checkOutNeededFlag = true,
                assignedBCBems = 3322323,
                overrideTraining = false,
            };
            TrainingInfo trainingInfo = new()
            {
                BemsId = 2519949,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "TR06005 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517AE",
                        IsTrainingValid = true,
                        Name = "77517AE Training"
                    }
                }
            };
            HTTPResponseWrapper<bool> response = new HTTPResponseWrapper<bool>()
            {
                Data = false,
                Message = "Person Not Checked In. Scan The Correct Badge or Enter the correct PIN of This Line's CC."
            };
            IList<WorkArea> workAreaList = new List<WorkArea> { new() { Area = "some-work-area" } };
            _mockAirplaneService.Setup(s => s.GetActiveWorkAreasAsync(vm.site, vm.program)).ReturnsAsync(workAreaList).Verifiable();
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(new User()).Verifiable();
            _mockCheckInService.Setup(s => s.PostCheckOutUserByBems(vm.bemsId))
                .ReturnsAsync(new HTTPResponseWrapper<CheckInRecord> { Status = Status.SUCCESS }).Verifiable();
            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 2519949, BadgeNumber = null });
            _mockExternalService.Setup(s => s.IsValidBadge(It.IsAny<int>(), It.IsAny<string>())).ReturnsAsync(response);
            var result = await _controller.CheckInUser(vm) as PartialViewResult;

            Assert.AreEqual("Partials/CheckInPartial", result.ViewName);
            _mockToastService.Verify(x => x.AddErrorToastMessage("Person Not Checked In. Scan The Correct Badge or Enter the correct PIN of This Line's CC.", It.IsAny<LibraryOptions>()));
        }

        [TestMethod]
        public async Task Should_Return_Data_When_BC_Badge_Matches_Assigned_BEMS()
        {
            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User(),
                assignedBCBems = _bcUser.BemsId,
                ConfirmingBCBadge = "8020450947"
            };
            HTTPResponseWrapper<bool> response = new HTTPResponseWrapper<bool>()
            {
                Data = true,
                Message = "BCs PIN Matches"
            };
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(new User());
            _mockExternalService.Setup(s => s.IsValidBadge(It.IsAny<int>(), It.IsAny<string>())).ReturnsAsync(response);

            var result = await _controller.CheckInUser(vm) as PartialViewResult;
            _mockCheckInTranslator.Verify(x => x.GetCheckInRecordFromViewModel(vm, It.IsAny<DateTime>(), "Check In", false));
        }

        [TestMethod]
        public async Task Should_Return_Data_When_BC_PIN_Matches_AssignedBC_PIN()
        {
            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User(),
                assignedBCBems = _bcUser.BemsId,
                ConfirmingCCPin = "5678",
                assignedCCPin = "BCe0hOVnvgQJ2lRmUD092kCqmtYz+U0G+B7rfNVcz/M="
            };
            HTTPResponseWrapper<bool> response = new HTTPResponseWrapper<bool>()
            {
                Data = true,
                Message = "BCs PIN Matches"
            };
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(new User());
            
            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<CheckInRecord>())).ReturnsAsync(new HTTPResponseWrapper<CheckInRecord>
            {
                Status = Status.SUCCESS
            });
            _mockUserService.Setup(s => s.IsValidPin(It.IsAny<int>(), It.IsAny<string>())).ReturnsAsync(response);
            var result = await _controller.CheckInUser(vm) as PartialViewResult;

            _mockCheckInTranslator.Verify(x => x.GetCheckInRecordFromViewModel(vm, It.IsAny<DateTime>(), "Check In", false));
            Assert.AreEqual("Partials/CheckInPartial", result.ViewName);
        }

        [TestMethod]
        public async Task Should_NotCheckIn_And_ReturnMessage_When_AssignedBCPin_Is_Null()
        {
            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User(),
                assignedBCBems = _bcUser.BemsId,
                ConfirmingCCPin = null,
                assignedCCPin = "BCe0hOVnvgQJ2lRmUD092kCqmtYz+U0G+B7rfNVcz/M="
            };

            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(new User());
            _mockUserService.Setup(s => s.IsValidPin(It.IsAny<int>(), It.IsAny<string>())).ReturnsAsync(new HTTPResponseWrapper<bool>());
            var result = await _controller.CheckInUser(vm) as PartialViewResult;

            Assert.AreEqual("Partials/CheckInPartial", result.ViewName);
            _mockToastService.Verify(x => x.AddErrorToastMessage("Person Not Checked In. Scan The Correct Badge or Enter the correct PIN of This Line's CC.", It.IsAny<LibraryOptions>()));
        }

        [TestMethod]
        public async Task Should_CheckInUser_Handle_Exception_From_External_Service()
        {
            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                CurrentUser = new User(),
                assignedBCBems = _bcUser.BemsId,
                ConfirmingCCPin = "5679",
                ConfirmingBCBadge = "8020450947"
            };
            HTTPResponseWrapper<bool> response = new HTTPResponseWrapper<bool>()
            {
                Message = "Person Not Checked In. Scan The Correct Badge or Enter the correct PIN of This Line's CC."
            };
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(new User());
            _mockExternalService.Setup(s => s.GetBemsIdFromBemsIdOrBadgeNumber(It.IsAny<string>())).ReturnsAsync(new HTTPResponseWrapper<int>());

            _mockExternalService.Setup(s => s.IsValidBadge(It.IsAny<int>(), It.IsAny<string>())).ReturnsAsync(response);

            var result = await _controller.CheckInUser(vm) as PartialViewResult;
            Assert.AreEqual("Partials/CheckInPartial", result.ViewName);
            _mockToastService.Verify(x => x.AddErrorToastMessage("Person Not Checked In. Scan The Correct Badge or Enter the correct PIN of This Line's CC.", It.IsAny<LibraryOptions>()));
        }

        // ============================================
        // NEW TEST CASES FOR BOEING AE SCENARIOS
        // ============================================

        // NEW: Direct Check-in scenarios for Boeing AE - All combinations in one method
        [TestMethod]
        public async Task Should_DirectlyCheckIn_When_BoeingAE_Has_Valid_77517_Training()
        {
            var successResponse = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.SUCCESS,
                Message = "Check In Successful"
            };

            // Test all 4 direct check-in combinations
            var trainingCombinations = new List<List<IMyLearningDataResponse>>
            {
                // Scenario 1: All trainings valid
                new List<IMyLearningDataResponse>
                {
                    new MyLearningDataResponse { CertCode = "TR06005", IsTrainingValid = true, Name = "TR06005 Training" },
                    new MyLearningDataResponse { CertCode = "85914", IsTrainingValid = true, Name = "85914 Training" },
                    new MyLearningDataResponse { CertCode = "77517AE", IsTrainingValid = true, Name = "77517AE Training" },
                    new MyLearningDataResponse { CertCode = "77517PAE", IsTrainingValid = true, Name = "77517PAE Training" },
                    new MyLearningDataResponse { CertCode = "77517GC", IsTrainingValid = true, Name = "77517GC Training" }
                },
                // Scenario 2: TR06005 valid, Any 77517 valid, 85914 invalid
                new List<IMyLearningDataResponse>
                {
                    new MyLearningDataResponse { CertCode = "TR06005", IsTrainingValid = true, Name = "TR06005 Training" },
                    new MyLearningDataResponse { CertCode = "85914", IsTrainingValid = false, Name = "85914 Training" },
                    new MyLearningDataResponse { CertCode = "77517PAE", IsTrainingValid = true, Name = "77517PAE Training" }
                },
                // Scenario 3: TR06005 invalid, Any 77517 valid, 85914 valid
                new List<IMyLearningDataResponse>
                {
                    new MyLearningDataResponse { CertCode = "TR06005", IsTrainingValid = false, Name = "TR06005 Training" },
                    new MyLearningDataResponse { CertCode = "85914", IsTrainingValid = true, Name = "85914 Training" },
                    new MyLearningDataResponse { CertCode = "77517GC", IsTrainingValid = true, Name = "77517GC Training" }
                },
                // Scenario 4: TR06005 invalid, Any 77517 valid, 85914 invalid
                new List<IMyLearningDataResponse>
                {
                    new MyLearningDataResponse { CertCode = "TR06005", IsTrainingValid = false, Name = "TR06005 Training" },
                    new MyLearningDataResponse { CertCode = "85914", IsTrainingValid = false, Name = "85914 Training" },
                    new MyLearningDataResponse { CertCode = "77517AE", IsTrainingValid = true, Name = "77517AE Training" }
                }
            };

            foreach (var trainingData in trainingCombinations)
            {
                TrainingInfo trainingInfo = new()
                {
                    BemsId = 123456,
                    MyLearningDataResponse = trainingData
                };

                _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
                _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 123456, BadgeNumber = null });
                _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult(successResponse));
                _mockCheckInTranslator.Setup(t => t.GetNewCheckInPartialVMAfterSuccess(It.IsAny<CheckInPartialViewModel>())).Returns(new CheckInPartialViewModel());

                CheckInPartialViewModel vm = new CheckInPartialViewModel
                {
                    overrideTraining = false,
                    CurrentUser = new User { BemsId = 2830715 },
                    bemsId = 123456,
                    personType = "Home Team"
                };

                var result = await _controller.CheckInUser(vm);
                var viewResult = (PartialViewResult)result;

                Assert.AreEqual("Partials/CheckInPartial", viewResult.ViewName);
                Assert.AreEqual("Success", viewResult.ViewData["Status"]);
            }

            _mockCheckInService.Verify(s => s.PostCheckinAsync(It.IsAny<CheckInRecord>()), Times.Exactly(4));
        }

        // NEW: Proceed button scenarios for Boeing AE - All combinations in one method
        [TestMethod]
        public async Task Should_Show_ProceedButton_When_BoeingAE_Has_No_Valid_77517_Training()
        {
            // Test all 3 proceed button combinations
            var trainingCombinations = new List<List<IMyLearningDataResponse>>
            {
                // Scenario 1: TR06005 valid, All 77517 invalid, 85914 valid
                new List<IMyLearningDataResponse>
                {
                    new MyLearningDataResponse { CertCode = "TR06005", IsTrainingValid = true, Name = "TR06005 Training" },
                    new MyLearningDataResponse { CertCode = "85914", IsTrainingValid = true, Name = "85914 Training" },
                    new MyLearningDataResponse { CertCode = "77517AE", IsTrainingValid = false, Name = "77517AE Training" },
                    new MyLearningDataResponse { CertCode = "77517PAE", IsTrainingValid = false, Name = "77517PAE Training" },
                    new MyLearningDataResponse { CertCode = "77517GC", IsTrainingValid = false, Name = "77517GC Training" }
                },
                // Scenario 2: TR06005 invalid, All 77517 invalid, 85914 valid
                new List<IMyLearningDataResponse>
                {
                    new MyLearningDataResponse { CertCode = "TR06005", IsTrainingValid = false, Name = "TR06005 Training" },
                    new MyLearningDataResponse { CertCode = "85914", IsTrainingValid = true, Name = "85914 Training" },
                    new MyLearningDataResponse { CertCode = "77517AE", IsTrainingValid = false, Name = "77517AE Training" },
                    new MyLearningDataResponse { CertCode = "77517PAE", IsTrainingValid = false, Name = "77517PAE Training" },
                    new MyLearningDataResponse { CertCode = "77517GC", IsTrainingValid = false, Name = "77517GC Training" }
                },
                // Scenario 3: TR06005 valid, All 77517 invalid, 85914 invalid
                new List<IMyLearningDataResponse>
                {
                    new MyLearningDataResponse { CertCode = "TR06005", IsTrainingValid = true, Name = "TR06005 Training" },
                    new MyLearningDataResponse { CertCode = "85914", IsTrainingValid = false, Name = "85914 Training" },
                    new MyLearningDataResponse { CertCode = "77517AE", IsTrainingValid = false, Name = "77517AE Training" },
                    new MyLearningDataResponse { CertCode = "77517PAE", IsTrainingValid = false, Name = "77517PAE Training" },
                    new MyLearningDataResponse { CertCode = "77517GC", IsTrainingValid = false, Name = "77517GC Training" }
                }
            };

            int testIteration = 0;
            foreach (var trainingData in trainingCombinations)
            {
                TrainingInfo trainingInfo = new()
                {
                    BemsId = 123456,
                    MyLearningDataResponse = trainingData
                };

                _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
                _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 123456, BadgeNumber = null });
                _mockUserService.Setup(s => s.GetUserByBemsidAsync(It.IsAny<int>())).ReturnsAsync(new User { DisplayName = "Test_User" });

                CheckInPartialViewModel vm = new CheckInPartialViewModel
                {
                    overrideTraining = false,
                    trainingConfirmation = false,
                    CurrentUser = new User { BemsId = 2830715 },
                    bemsId = 123456,
                    personType = "Home Team"
                };

                var result = await _controller.CheckInUser(vm);
                var viewResult = (PartialViewResult)result;
                var model = (CheckInPartialViewModel)viewResult.Model;

                Assert.AreEqual("Partials/TrainingStatusPartial", viewResult.ViewName, $"Failed on iteration {testIteration}");
                Assert.IsTrue(model.trainingConfirmation, $"Failed on iteration {testIteration}");
                Assert.IsFalse(model.overrideTraining, $"Failed on iteration {testIteration}");

                testIteration++;
            }
        }

        // NEW: Test proceed button then check-in
        [TestMethod]
        public async Task Should_CheckIn_After_Clicking_Proceed_Button()
        {
            var successResponse = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.SUCCESS,
                Message = "Check In Successful"
            };

            TrainingInfo trainingInfo = new()
            {
                BemsId = 123456,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse { CertCode = "TR06005", IsTrainingValid = true, Name = "TR06005 Training" },
                    new MyLearningDataResponse { CertCode = "85914", IsTrainingValid = true, Name = "85914 Training" },
                    new MyLearningDataResponse { CertCode = "77517AE", IsTrainingValid = false, Name = "77517AE Training" },
                    new MyLearningDataResponse { CertCode = "77517PAE", IsTrainingValid = false, Name = "77517PAE Training" },
                    new MyLearningDataResponse { CertCode = "77517GC", IsTrainingValid = false, Name = "77517GC Training" }
                }
            };

            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 123456, BadgeNumber = null });
            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult(successResponse));
            _mockCheckInTranslator.Setup(t => t.GetNewCheckInPartialVMAfterSuccess(It.IsAny<CheckInPartialViewModel>())).Returns(new CheckInPartialViewModel());

            // User clicks Proceed button - trainingConfirmation flag set to true
            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                overrideTraining = false,
                trainingConfirmation = true,
                CurrentUser = new User { BemsId = 2830715 },
                bemsId = 123456,
                personType = "Home Team"
            };

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;

            Assert.AreEqual("Partials/CheckInPartial", viewResult.ViewName);
            Assert.AreEqual("Success", viewResult.ViewData["Status"]);
            _mockCheckInService.Verify(s => s.PostCheckinAsync(It.IsAny<CheckInRecord>()), Times.Once);
        }

        // NEW: Test override button then check-in
        [TestMethod]
        public async Task Should_CheckIn_After_Clicking_Override_Button()
        {
            var successResponse = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.SUCCESS,
                Message = "Check In Successful"
            };

            TrainingInfo trainingInfo = new()
            {
                BemsId = 123456,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse { CertCode = "TR06005", IsTrainingValid = false, Name = "TR06005 Training" },
                    new MyLearningDataResponse { CertCode = "85914", IsTrainingValid = false, Name = "85914 Training" },
                    new MyLearningDataResponse { CertCode = "77517AE", IsTrainingValid = false, Name = "77517AE Training" },
                    new MyLearningDataResponse { CertCode = "77517PAE", IsTrainingValid = false, Name = "77517PAE Training" },
                    new MyLearningDataResponse { CertCode = "77517GC", IsTrainingValid = false, Name = "77517GC Training" }
                }
            };

            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 123456, BadgeNumber = null });
            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult(successResponse));
            _mockCheckInTranslator.Setup(t => t.GetNewCheckInPartialVMAfterSuccess(It.IsAny<CheckInPartialViewModel>())).Returns(new CheckInPartialViewModel());

            // User clicks Override button - overrideTraining flag set to true
            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                overrideTraining = true,
                trainingConfirmation = false,
                CurrentUser = new User { BemsId = 2830715 },
                bemsId = 123456,
                personType = "Home Team"
            };

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;

            Assert.AreEqual("Partials/CheckInPartial", viewResult.ViewName);
            Assert.AreEqual("Success", viewResult.ViewData["Status"]);
            _mockCheckInService.Verify(s => s.PostCheckinAsync(It.IsAny<CheckInRecord>()), Times.Once);
        }

        // ============================================
        // NEW TEST CASES FOR VISITOR SCENARIOS
        // ============================================

        // NEW: Visitor with valid training - direct check-in
        [TestMethod]
        public async Task Should_DirectlyCheckIn_For_Visitor_Using_BemsID_With_Valid_Training()
        {
            var successResponse = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.SUCCESS,
                Message = "Check In Successful"
            };

            TrainingInfo trainingInfo = new()
            {
                BemsId = 123456,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "77517X36106",
                        IsTrainingValid = true,
                        Name = "Visitor Training"
                    }
                }
            };

            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 123456, BadgeNumber = "123456789" });
            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult(successResponse));
            _mockCheckInTranslator.Setup(t => t.GetNewCheckInPartialVMAfterSuccess(It.IsAny<CheckInPartialViewModel>())).Returns(new CheckInPartialViewModel());

            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                overrideTraining = false,
                CurrentUser = new User { BemsId = 2830715 },
                bemsId = 123456,
                personType = "Visitor"
            };

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;

            Assert.AreEqual("Partials/CheckInPartial", viewResult.ViewName);
            Assert.AreEqual("Success", viewResult.ViewData["Status"]);
            _mockCheckInService.Verify(s => s.PostCheckinAsync(It.IsAny<CheckInRecord>()), Times.Once);
        }

        // NEW: Visitor with invalid training - show override button
        [TestMethod]
        public async Task Should_Show_OverrideButton_For_Visitor_Using_BemsID_With_Invalid_Training()
        {
            TrainingInfo trainingInfo = new()
            {
                BemsId = 123456,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "77517X36106",
                        IsTrainingValid = false,
                        Name = "Visitor Training"
                    }
                }
            };

            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 123456, BadgeNumber = "123456789" });
            _mockUserService.Setup(s => s.GetUserByBemsidAsync(It.IsAny<int>())).ReturnsAsync(new User { DisplayName = "Visitor_User" });

            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                overrideTraining = false,
                CurrentUser = new User { BemsId = 2830715 },
                bemsId = 123456,
                personType = "Visitor"
            };

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;
            var model = (CheckInPartialViewModel)viewResult.Model;

            Assert.AreEqual("Partials/TrainingStatusPartial", viewResult.ViewName);
            Assert.IsTrue(model.overrideTraining);
            Assert.AreEqual("Visitor_User", model.recordDisplayName);
        }

        // NEW: Visitor override button then check-in
        [TestMethod]
        public async Task Should_CheckIn_After_Clicking_Override_Button_For_Visitor()
        {
            var successResponse = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.SUCCESS,
                Message = "Check In Successful"
            };

            TrainingInfo trainingInfo = new()
            {
                BemsId = 123456,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "77517X36106",
                        IsTrainingValid = false,
                        Name = "Visitor Training"
                    }
                }
            };

            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 123456, BadgeNumber = "123456789" });
            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult(successResponse));
            _mockCheckInTranslator.Setup(t => t.GetNewCheckInPartialVMAfterSuccess(It.IsAny<CheckInPartialViewModel>())).Returns(new CheckInPartialViewModel());

            // User clicks Override button for visitor
            CheckInPartialViewModel vm = new CheckInPartialViewModel
            {
                overrideTraining = true,
                CurrentUser = new User { BemsId = 2830715 },
                bemsId = 123456,
                personType = "Visitor"
            };

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;

            Assert.AreEqual("Partials/CheckInPartial", viewResult.ViewName);
            Assert.AreEqual("Success", viewResult.ViewData["Status"]);
            _mockCheckInService.Verify(s => s.PostCheckinAsync(It.IsAny<CheckInRecord>()), Times.Once);
        }

        #endregion CheckIn UserkedInResult));
            _mockSessionService.Setup(s => s.GetUserFromSession(It.IsAny<HttpContext>())).Returns(_bcUser);
            _mockExternalService.Setup(s => s.GetBemsIdFromBemsIdOrBadgeNumber(It.IsAny<string>())).ReturnsAsync(bemsWrapper);
            _mockExternalService.Setup(s => s.GetMyLearningDataAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>())).ReturnsAsync(trainingInfo);
            _mockCheckInTranslator.Setup(s => s.GetCheckInRecordFromViewModel(It.IsAny<CheckInPartialViewModel>(), It.IsAny<DateTime>(), It.IsAny<string>(), It.IsAny<bool>())).Returns(new CheckInRecord() { BemsId = 2519949, BadgeNumber = null });

            CheckInPartialViewModel vm = new CheckInPartialViewModel()
            {
                overrideTraining = false,
                CurrentUser = new User { BemsId = 123 }
            };

            var result = await _controller.CheckInUser(vm);
            var viewResult = (PartialViewResult)result;

            Assert.AreEqual("Partials/CheckOutCheckInPartial", viewResult.ViewName);
            Assert.AreEqual(viewResult.Model, vm);
        }

        [TestMethod]
        public async Task Should_PersistWorkAreaData_When_Returning_CheckOutCheckInPartial()
        {
            var errorMessage = "User 2519949 is currently checked in on Line 100. They must check out there in order to check in here.";
            var alreadyCheckedInResult = new HTTPResponseWrapper<Shield.Ui.App.Models.CommonModels.CheckInRecord>
            {
                Status = Shield.Common.Constants.ShieldHttpWrapper.Status.NOT_MODIFIED,
                Reason = Shield.Common.Constants.ShieldHttpWrapper.Reason.ALREADY_EXISTS,
                Message = errorMessage,
                Data = new Shield.Ui.App.Models.CommonModels.CheckInRecord
                {
                    BemsId = 2519949,
                    WorkAreaIdString = "10, 11"
                }
            };

            TrainingInfo trainingInfo = new()
            {
                BemsId = 2519949,
                MyLearningDataResponse = new List<IMyLearningDataResponse>()
                {
                    new MyLearningDataResponse
                    {
                        CertCode = "TR06005",
                        IsTrainingValid = true,
                        Name = "TR06005 Training"
                    },
                    new MyLearningDataResponse
                    {
                        CertCode = "77517PAE",
                        IsTrainingValid = true,
                        Name = "77517PAE Training"
                    }
                }
            };

            HTTPResponseWrapper<int> bemsWrapper = new HTTPResponseWrapper<int>
            {
                Data = 2519949
            };

            _mockCheckInService.Setup(x => x.PostCheckinAsync(It.IsAny<Shield.Ui.App.Models.CommonModels.CheckInRecord>())).Returns(Task.FromResult(alreadyChec